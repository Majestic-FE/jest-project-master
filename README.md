# フロントエンドテスト戦略・考え方
## はじめに
このREADMEでは、テストでの歴史から考え方を共有します。
もし、テストの書き方をご覧になりたい方は、
[React JEST・React Testing Library入門（srcフォルダの直下）](https://github.com/bu-abe/jest-project/tree/master/src#react-jestreact-testing-library%E5%85%A5%E9%96%80)をご参照ください。
## 目次
- [フロントエンドテスト戦略・考え方](#フロントエンドテスト戦略考え方)
  - [はじめに](#はじめに)
  - [目次](#目次)
  - [そもそもテストとは？](#そもそもテストとは)
  - [テストの目的](#テストの目的)
  - [テストをするにあったての課題](#テストをするにあったての課題)
  - [テスト方針の概念](#テスト方針の概念)
    - [ピラミッド型](#ピラミッド型)
    - [トロフィー型](#トロフィー型)
    - [E2Eテストだけでよくね？](#e2eテストだけでよくね)
  - [トロフィー型に従う場合のテスト観点](#トロフィー型に従う場合のテスト観点)
    - [1. 「実装の詳細」をテストしない](#1-実装の詳細をテストしない)
    - [2. 「コードカバレッジ」より「ユースケースカバレッジ」を意識する](#2-コードカバレッジよりユースケースカバレッジを意識する)
    - [各テストのツール紹介](#各テストのツール紹介)
  - [まとめ](#まとめ)
  - [参考文献](#参考文献)

## そもそもテストとは？
アプリケーションが想定どおりに機能することを評価および検証すること

## テストの目的
信頼できるアプリケーションを作ることです。
つまり、**品質の保証**を指しています。
<br>
詳細をいうと、
- バグを防ぐこと
- リグレッションを防ぐこと

やはりこの点が大きいと思います。

## テストをするにあったての課題
プロジェクトの運用形態によって変わりますが、大きく分けて三点挙げられます。
- **実装する仕様について、プロジェクト内でどう認識合わせするか？**<br>
仕様の把握は重要なところであり、認識のずれがあるとテストを書き直すコストがかかってしまうため、認識合わせが必要です。
- **コスト（工数)などの面をどう考慮するか**<br>
- **テストの精度、粒度をどう考えるか？**<br>
ユーザーの操作等の副作用、コストメリットなど

特に、全てのテストケースを記載していたらいくら工数があっても足りません。<br>
例えば、入力フォームのみのテストであれば、簡単なのですが、
バリデーション付きのテストもすると、難易度・コストは高くなります。
そのため、どの範囲までテストをするのか取捨選択をする必要があります。

そこで、どういう方針でテストを書けば良いのでしょうか？

## テスト方針の概念
このセクションでは、いくつかのテストの概念を歴史を追って説明していきます。

### ピラミッド型
![](https://i.imgur.com/LW202ZU.png)


昔からあるテストの方針の概念であり、「ピラミッドの面積の比率」が「テストの総量の比率」を表しています。<br>
例でユニットテストに焦点を当てると、速度が早くコストが小さいが、テスト総量が多いことがわかります。<br>
ピラミッド型は、速度とコスト(工数)のみを考慮していて、ユニットテストを主として書くことを提唱しています。

このピラミッド型は、欠点がありました。

それは、品質の保証を考慮していないことです。<br>
その結果、テスト本来の目的からズレていることが指摘されてきました。
<br>

### トロフィー型
そこで、提唱されたのがトロフィー型になります。

![](https://i.imgur.com/1xxNBLm.png)


「速度・工数・保証」のトレードオフの関係性を表すものとなっています。<br>
トレードオフとは、何かを得ると別の何かを失う、相容れない関係のことであり一得一失のことです。
<br>
両端の矢印は、ピラミッド型と同じです。
真ん中の矢印は、この指針の特徴の1つである「品質(正常に動作する)の保証」を表しています。

トロフィー型ではテストを以下のように分類します。

1. **Static（静的テスト）**<br>
   プログラムの実行なしで検証すること
2. **ユニットテスト(単体テスト)**<br>
   独立した関数・コンポーネントが正常に動くか検証すること
3. **インテグレーションテスト（結合テスト）**<br>
   機能を組み合わせて正常に動くかを検証すること
4. **E2Eテスト(UIテスト)**<br>
   ユーザーの振る舞いを想定したシステム全体の動作のテスト

### E2Eテストだけでよくね？
品質の保証だったら、E2Eテストだけでよくね？と疑問を持った方もいらっしゃるかも知れません。
<br>
E２Eテストに重きを置いたテストを行うメリットを言うと、
- **エンジニアは、実際に動かしてテストすることにかける時間を減らせる。**(フロントエンドなら尚更)
- **PMの方々は、バグの影響範囲を把握できる。**
- **QAの方々は、バグを見逃すことが少なくなる。**<br>
→エンジニアが先にテストしているため

しかし、E２Eテストに重きを置いたテストを行うデメリットは、
- **バグが起きた時の根本的な原因を見つけることが困難。**
- **テスト作成やメンテナンス時間がかかる。**
- **E2Eテストの動作が不安定の時がある。**<br>
→バグが再現したりしなかったりすることもある。

テストの価値は、バグを見つけ修正することなので、<br>
バグの要因になる部分を潰せるテストやコストがかからないテストが必要になります。

そのため、トレードオフのバランスの観点から見ると、<br>
インテグレーションテストがバランスが良く、一番書くべきだと提唱しています。

## トロフィー型に従う場合のテスト観点
特に自分が感じた必要な観点は、以下のようになります。
1. **「実装の詳細」をテストしない**
2. **「コードカバレッジ」より「ユースケースカバレッジ」を意識する**

### 1. 「実装の詳細」をテストしない
「実装の詳細」とは、ユーザーから見えないものです。<br>
例えば、チェックボックスでいうと、<br>
ユーザーはチェックボックスをクリックした際に、isCheckedがtrueだと知る由もありません。<br>
あくまでユーザーは、チェックボックスにチェックがついているかついていないかということしか分かりません。

実装の詳細をテストすることは、避けるべきです。<br>
理由は、下記二点を生んでしまうからです。
1. **挙動は正常なのにテストが通らないことが起きてしまう。**<br>
特にリファクタリングをするとテストコードが壊れます。<br>
リファクタリングとは、まさに実装の詳細を変更することなので、テストによっては挙動は変わっていないのにテストが通らないという現象が起きてしまい、テストコードを壊してしまいます。
2. **挙動が正常ではないのにテストが通ってしまうことが起きてしまう。**<br>
特にユニットテストしか行っていない時に起きます。<br>
ユニットテストは、コンポーネントの実装の詳細をテストする粒度の小さいテストです。<br>
コンポーネント単位でしか機能の保証ができていないが故に、結合をした後挙動が変になってしまった時、テストが通ってしまうことが起きてしまいます。

### 2. 「コードカバレッジ」より「ユースケースカバレッジ」を意識する
先に用語の意味を説明します。
- **コードカバレッジ**<br>
コード全体の中で、テストが行われた割合のこと。<br>
日本語で言うと、コード網羅率と言います。
- **ユースケースカバレッジ**<br>
ユースケース全体の中で、テストが行われた割合のこと。

何が言いたいかと言うと、コードベースのテストを行うより、ユースケースのテストを潰すことを意識する必要がある。<br>
つまり、ユニットテストよりインテグレーションテストを意識して書くことが重要と言うことです。<br>
その結果、「システムが正しく動くという保証レベル」を上げることに繋がります。

### 各テストのツール紹介
**ツールの代表例**
1. 静的テスト
    * ESLint
    * TypeScript

2. ユニットテスト
    * Jest
    * Mocha

3. インテグレーションテスト
    * React Testing Library
    * Enzyme

4. E2Eテスト
    * Cypress
    * Autify

[※ツールの詳しい情報はHowToの方で解説します。](https://github.com/bu-abe/jest-project/tree/master/src#react-jestreact-testing-library%E5%85%A5%E9%96%80)

## まとめ
今まで、テスト方針の重要性を記載しました。<br>
もし、プロジェクトにテストを入れるなら、それぞれのプロジェクトによって性質が違ってくると思うので、今まで述べてきたこと（テストの方針やテストの観点など）を考慮してテストを行うと良いと思います。

ちなみに、最近サイボウズのエンジニアの方が投稿した実装例が参考になるので、ぜひご覧ください。
[実装例から見る React のテストの書き方 - Cybozu Inside Out | サイボウズエンジニアのブログ](https://blog.cybozu.io/entry/2022/08/29/110000)

## 参考文献
- [今日からはじめるReactのテスト戦略](https://zenn.dev/t_keshi/articles/react-test-rule)
- [【フロントエンド】コンポーネント指向 React / Vue のテスト方針](https://qiita.com/mrnaoki/items/3fd211deb8711fae8204)
- [React の テスト方針を調べた](https://zenn.dev/longbridge/articles/38572a8a9970f4)
- [React テスト応用、テストに悩む人へ](https://zenn.dev/tkdn/books/react-testing-patterns/viewer/about-this-book)
- [フロントエンドでTDDを実践する（理論編）](https://qiita.com/taneba/items/48db2ad9cf10ad644908)
- [トロフィー型提唱者：kentのブログ](https://kentcdodds.com/blog?q=testing)
- [JavaScript開発のためのテスト入門  第1回 テストとはなにか](https://www.codegrid.net/articles/js-test-1/)
